<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Frame — STT + OpenRouter + Картинка + TTS</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:url("images/wallpaper.jpg")center/cover no-repeat fixed;overflow:hidden;color:#fff;}
.app{display:flex;width:100%;height:100%;}
#text-panel{flex:1;display:flex;justify-content:center;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border-right:1px solid rgba(255,255,255,0.08);padding:20px;font-size:24px;font-weight:600;line-height:1.4;overflow-wrap:break-word;opacity:0;transform:translateX(-50px);transition:all 0.5s ease;}
#image-panel{flex:1;display:flex;justify-content:center;align-items:center;}
#ai-image{max-width:90%;max-height:90%;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,0.4);opacity:0;transform:translateX(50px);transition:all 0.5s ease;}
#clock{position:absolute;top:12px;left:12px;font-size:22px;font-weight:600;padding:6px 18px;background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);border-radius:50px;backdrop-filter:blur(6px);}
#fullscreen-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;padding:20px 40px;border:none;border-radius:24px;background:rgba(255,255,255,0.3);color:#fff;backdrop-filter:blur(12px);cursor:pointer;}
#fullscreen-btn:hover{background:rgba(255,255,255,0.5);}
@media(max-width:480px){#text-panel{font-size:18px;}#fullscreen-btn{font-size:20px;padding:16px 32px;}}
</style>
</head>
<body>
<div class="app">
  <div id="text-panel"></div>
  <div id="image-panel"><img id="ai-image" src="" alt="AI Image"></div>
  <div id="clock">--:--</div>
  <button id="fullscreen-btn">ВО ВЕСЬ ЭКРАН</button>
</div>

<script>
// --- Часы ---
const clock=document.getElementById('clock');
function updateClock(){
  const now=new Date();
  clock.textContent=String(now.getHours()).padStart(2,"0")+":"+String(now.getMinutes()).padStart(2,"0");
}
setInterval(updateClock,1000);updateClock();

// --- Fullscreen ---
const fsBtn=document.getElementById('fullscreen-btn');
fsBtn.addEventListener('click',()=>{
  if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen();
  fsBtn.style.display='none';
});

// --- Панель текста и картинки ---
const textPanel=document.getElementById('text-panel');
const imgEl=document.getElementById('ai-image');

// --- Отображение текста и картинки ---
function showTextWithAnimation(text){
  textPanel.textContent=text;
  textPanel.style.opacity=1;
  textPanel.style.transform="translateX(0)";
  speakText(text); // воспроизведение текста
}
function showImageWithAnimation(src){
  imgEl.src=src;
  imgEl.style.opacity=1;
  imgEl.style.transform="translateX(0)";
}

// --- TTS ---
let ttsInProgress=false;
function speakText(text){
  if(!window.speechSynthesis) return;
  ttsInProgress=true;
  const utterance=new SpeechSynthesisUtterance(text);
  utterance.lang='ru-RU';
  utterance.rate=1;
  utterance.pitch=1;
  utterance.onend=()=>{
    ttsInProgress=false;
    if(recog) try{recog.start();}catch(e){console.warn(e);}
  };
  window.speechSynthesis.speak(utterance);
}

// --- OpenRouter GPT + Unsplash ---
async function getOpenRouterResponse(promptText){
  const token="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";
  const url="https://openrouter.ai/api/v1/chat/completions";
  const body={
    model:"gpt-4o-mini",temperature:0.3,max_tokens:1000,
    messages:[
      {role:"system",content:"Отвечай кратко, без смайликов. В конце ответа укажи KEYWORDS: English words for image search, но не показывай их пользователю."},
      {role:"user",content:promptText}
    ]
  };
  try{
    const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify(body)});
    const data=await res.json();
    let answer="Нет ответа", keywords=promptText;
    if(data.choices?.[0]?.message?.content){
      answer=data.choices[0].message.content;
      const match=answer.match(/KEYWORDS:\s*(.+)/i);
      if(match){keywords=match[1].trim(); answer=answer.replace(match[0],"").trim();}
    }
    showTextWithAnimation(answer);

    try{
      const u=await fetch(`https://api.unsplash.com/photos/random?query=${encodeURIComponent(keywords)}&client_id=5cNGGhySiIPu1aKITVFVoPBawvJyQSaY9RVAuu2wh4g`);
      const imgData=await u.json();
      const imgUrl=imgData?.urls?.regular || "https://via.placeholder.com/600x400?text=Картинка+не+найдена";
      showImageWithAnimation(imgUrl);
    }catch(e){showImageWithAnimation("https://via.placeholder.com/600x400?text=Ошибка");}

  }catch(e){
    console.error(e);
    showTextWithAnimation("Ошибка сети");
    showImageWithAnimation("https://via.placeholder.com/600x400?text=Ошибка");
  }
}

// --- STT с автоперезапуском ---
const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;
let recog;
function startSTT(){
  if(!Rec){textPanel.textContent="Speech API не поддерживается"; return;}
  recog=new Rec();
  recog.lang="ru-RU";
  recog.interimResults=false;
  recog.continuous=true;

  recog.onresult=e=>{
    if(ttsInProgress) return; // игнорируем, пока идет TTS
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      if(r.isFinal){
        const text=r[0].transcript.trim();
        getOpenRouterResponse(text);
      }
    }
  };
  recog.onerror=ev=>{console.warn("STT error:",ev); setTimeout(()=>recog.start(),500);}
  recog.onend=()=>{
    if(!ttsInProgress) setTimeout(()=>recog.start(),500);
  };
  try{recog.start();}catch(e){console.warn(e);}
}
startSTT();
</script>
</body>
</html>
